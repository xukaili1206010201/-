/**
 * Created by crazybear on 16/4/21.
 */
'use strict';

var guanjiaModuleController = angular.module('guanjiaModuleController', []);

//社区服务
guanjiaModuleController.controller(
  'comServiceCtrl',
  function ($scope, $rootScope, guanjiaService, userService, $state, $location, commonService, $sce, $http, $cookies, $q) {

    //项目圈字
    //$scope.font='乐生活';
    //var attr=$scope.font.split('');
    //$scope.fontHtml='';
    //for(var i=0;i<attr.length;i++){
    //  var Html='';
    //  Html=attr[i];
    //  $scope.fontHtml= $scope.fontHtml +'<span class="image-title">' + Html + '</span>';
    //}

    //清除历史纪录
    $cookies.remove('businessId');
    $cookies.remove('from');
    $cookies.remove('city_fuwu_id');
    $cookies.remove('tab');

    //*************广告轮播图**************
    $scope.imgShow = true;
    var params = {
      "type": "system",
      "city_id": sessionStorage.gpscityId,
      "label": '社区服务'
    };

    userService.postRequestWithUrlAndParams("listAd.action", params).success(function (response) {

      switch (response.code) {
        case '0':
          if (response.data) {
            $scope.adList = response.data;
            //$scope.adList = [{"imageUrl":"images/1.jpg"},{"imageUrl":"images/1.jpg"}];

            $scope.myInterval = 3000;
            var slides = $scope.slides = [];

            for (var i = 0; i < $scope.adList.length; i++) {
              var src = $scope.adList[i].imageUrl;
              slides.push({image: src, text: $scope.adList[i].name});
            }

            if ($scope.slides != '') {
              //轮播图请求到数据1秒后显示
              setTimeout(function () {
                $scope.imgShow = false;
              }, 1000);
            }

          }

          break;
        case '-1':
          console.log("社区服务轮播图参数为空");
          break;
      }
    }).error(function (data, status, header, config) {

    });

    //统计未读数量
    $scope.getunReadCount = function () {
      var defer = $q.defer();
      if ($cookies.get('ticket')) {
        guanjiaService.count({
          ticket: $cookies.get('ticket')
        }).success(function (response) {
          if (response.code == '0') {
            $scope.cart = response.data.cart;
            $scope.order = response.data.order;
            $scope.message = response.data.message;
            $scope.coupons = response.data.coupons;
            $scope.isShow = true;
            defer.resolve(response.data);
          } else {
            $scope.isShow = false;
          }
        });
      }
      return defer.promise;
    };
    $scope.countPromise = $scope.getunReadCount();

    //热门服务
    guanjiaService.listCityService({
      city_id: sessionStorage.gpscityId,
      //city_id: '8a28d7d855773dee015577423fa00002',
      hot: '0'
    }).success(function (response) {
      console.log(response)
      switch (response.code) {
        case '0':
          $scope.hotType = response.data.type;
          $scope.hotData = response.data;
          $scope.Hotjump = function (hotType, fuwu_id) {

            $rootScope.hotFuwu_id = fuwu_id;
            switch (hotType) {
              case '特供服务':
                $state.go('guanjia-support', {from: '1'});
                break;
              case '家庭服务':
                $state.go('guanjia-familyservice', {from: '1'});
                break;
              case '家庭金融':
                $state.go('guanjia-familyaccount');
                break;
            }
          };


      }

    }).error(function () {
    });

    //*************end**************

    //进入我的消息
    $scope.jumpUsermessage = function () {
      if ($cookies.get('ticket') == null) {
        $state.go('member-personal-login');
        sessionStorage.loginLocation = $location.path();
      } else {
        $state.go('member-user-message', {from: '0'});
      }
    };
    //进入我的优惠券
    $scope.jumpMycoupons = function () {
      if ($cookies.get('ticket') == null) {
        $state.go('member-personal-login');
        sessionStorage.loginLocation = $location.path();
      } else {
        $state.go('member-user-mycoupons');
      }
    };
    //进入我的购物车
    $scope.jumpCart = function () {
      if ($cookies.get('ticket') == null) {
        $state.go('member-personal-login');
        sessionStorage.loginLocation = $location.path();
      } else {
        $state.go('member-user-cart', {from: 0});
      }
    };
    //进入我的订单
    $scope.jumpMyorder = function () {
      if ($cookies.get('ticket') == null) {
        $state.go('member-personal-login');
        sessionStorage.loginLocation = $location.path();
      } else {
        $state.go('member-user-myorder', {"from": 0});
      }
    };

    //进入公共服务
    $scope.jumpPublicservice = function () {
      $state.go('guanjia-publicservice');
    };
    //进入特供服务
    $scope.jumpSupport = function () {
      var expireDate = new Date();
      expireDate.setDate(expireDate.getDate() + 30);
      $cookies.put('from', '%tegong%', {'expires': expireDate.toUTCString()});
      $state.go('guanjia-support', {from: '0'});
    };

    //进入在线超市
    $scope.jumpShopping = function () {
      $state.go('guanjia-shoppingonline');
    };

    //进入家庭服务
    $scope.jumpFamilyservice = function () {
      var expireDate = new Date();
      expireDate.setDate(expireDate.getDate() + 30);
      $cookies.put('from', '%jiating%', {'expires': expireDate.toUTCString()});
      $state.go('guanjia-familyservice', {from: '0'});
    };

    //进入家庭金融
    $scope.jumpFamilyaccount = function () {
      $state.go('guanjia-familyaccount');
    };

    //进入活动召集
    $scope.jumpActivity = function () {
      $state.go('member-user-callactivity');
    };

  }
);

//请求商家列表数据
guanjiaModuleController.controller(
  'supportCtrl',
  function ($scope, $rootScope, guanjiaService, userService, $state, commonService, $q, $cookies, $stateParams) {
    /************************************ 初始化  ****************************************/
    $scope.formData = {};
    $scope.myInterval = 3000; //轮播图播放间隔时间
    $scope.from = $stateParams.from; //from  0:特供服务  1:顺手早餐
    var tabIndex = $rootScope.supportTabIndex;

    /**
     *   获取特供服务的城市服务卡头和对应服务的商家
     */
    $scope.specialService = getSpeciaService();

    function getSpeciaService() {
      var defer = $q.defer();
      guanjiaService.listCityService({
        city_id: sessionStorage.gpscityId,
        type: '特供服务'
      }).success(function (data) {

        if (data.data.length > 0) {
          $scope.supportContent = true;//有城市服务数据
          $scope.fuwu_id = data.data;
          defer.resolve($scope.fuwu_id);
          //获取服务id和index分别存入数组$scope.fuwu和fuwu_count
          $scope.fuwu = [];
          $scope.fuwu_count = [];
          $.each($scope.fuwu_id, function (index, info) {
            $scope.fuwu_count.push(index);
            $scope.fuwu.push(info.city_fuwu_id);
          });

          //初次进入特供服务的商家列表
          if ($scope.from != '1') {
            var intiInde = null == tabIndex ? 0 : tabIndex;
            $scope.params.city_fuwu_id = $scope.fuwu_id[intiInde].city_fuwu_id;
            //根据不同服务赋值给label，在跑马灯指令里,和公告里都已使用。
            // 这是初次进入，后面的修改在卡头更换事件里
            $scope.label = $scope.fuwu_id[intiInde].label;
            getAdverts(); //获得对应的轮播图
            getNotice();//获得对应的跑马灯数据
            if (!$scope.fuwu_id[intiInde].config) {   //后台要求等于0就显示城市提示信息
              $scope.isShowPrompt = true;
              getPrompt($scope.fuwu_id[intiInde].city_fuwu_id);//获得城市对应的提示
            } else {
              $scope.isShowPrompt = false;
            }
          }
          //从顺手早餐进入的
          else if ($scope.from == '1') {
            $scope.breakfastFuwu_id = $rootScope.hotFuwu_id;
            $scope.params.city_fuwu_id = $scope.breakfastFuwu_id;
            // 早餐所对应的index
            $.each($scope.fuwu, function (i, value) {
              if (value == $scope.breakfastFuwu_id) {
                $scope.drycleanIndex = i;
              }
            });
            $scope.label = $scope.fuwu_id[$scope.drycleanIndex].label;

            getAdverts(); //获得对应的轮播图
            getNotice();//获得对应的跑马灯数据
            if ($scope.fuwu_id[$scope.drycleanIndex].config == 0) {   //后台要求等于0就显示城市提示信息
              $scope.isShowPrompt = true;
              getPrompt($scope.breakfastFuwu_id);
            } else {
              $scope.isShowPrompt = false;
            }

          }

        } else {
          $scope.supportContent = false;//无城市服务数据
          //commonService.showErrorMessage("该城市暂无相关服务！");
        }
        $scope.businessFun($scope.params);
      });
      return defer.promise;
    }

    /**end*/


    /**
     * 广告轮播图
     */
    $scope.imgShow = true;
    function getAdverts() {
      var promise = guanjiaService.getAdverts($scope.label);
      promise.then(function (data) {
        if (data != null && data.length > 0) {
          $scope.slides = data;
          //轮播图请求到数据1秒后显示
          setTimeout(function () {
            $scope.imgShow = false;
          }, 1000);
        } else {
          $scope.slides = null;
        }

      });
    }


    /**
     *  获取公告数据
     */
    function getNotice() {
      var noticeParams = {
        type: 'system,city',
        city_id: sessionStorage.gpscityId,
        label: $scope.label
      };
      guanjiaService.getNotice(noticeParams).then(function (data) {
        if (data != null && data.length > 0) {
          var marqueeContent = '';
          for (var i = 0; i < data.length; i++) {
            marqueeContent += '<li>' + data[i].content + '<li>';
          }
          marqueeContent = "<marquee behavior='scroll'  scrollAmount='" + $scope.slide + "'>" +
            "<ul class='list-inline'>" + marqueeContent + "</ul></marquee>";
          $('.marquee-broadcast').html(marqueeContent);
          $('.marquee-broadcast').css('display', 'block');
        } else {
          $('.marquee-broadcast').css('display', 'none');
        }
      }, function (err) {
        commonService.showErrorMessage("请求错误！");
      });
    }

    /**
     * 获取城市服务提示数据
     */
    function getPrompt(fuwu_id) {
      var params = {
        fuwu_id: fuwu_id
      };
      guanjiaService.getCityServicePrompt(params).then(function (reponse) {
        if (reponse.data != null) {
          switch (reponse.data.code) {
            case '0':
              $scope.promptData = reponse.data.data;
              break;
            case '1':
              commonService.showErrorMessage("参数为空!");
              break;
            case '2':
              commonService.showErrorMessage("参数错误!");
              break;
          }
        }
      }, function (error) {
        commonService.showErrorToast("请求错误,请稍后再试~")
      });
    }

    //特供服务和早餐请求参数
    if ($scope.from != '1') {
      $scope.params = {
        city_id: sessionStorage.gpscityId,
        city_fuwu_id: '',
        pageno: '1', //页码
        pagesize: '10', //页数
        url: 'listBusiness.action',
        direction: 'up',
        fuwuType: '0', //判断是否首次加载，0：默认为初次加载页面，1：不是初次加载页面
        key: ''
      };
    } else {
      $scope.params = {
        city_id: sessionStorage.gpscityId,
        city_fuwu_id: '',
        pageno: '1', //页码
        pagesize: '10', //页数
        url: 'listBusiness.action',
        direction: 'up',
        fuwuType: '1',
        key: ''
      }
    }

    $scope.business = [];
    var isOver = false; //false:标志数据未加载完成
    $scope.errMsg = '';
    $scope.businessFun = function (params) {
      var defer = $q.defer();
      userService.postRequestWithPageNo(params).success(function (response) {
        var tempList = response.data.list;
        $scope.allBusiness = response.data;
        if (tempList.length == 0 && params.pageno == '1') {
          $scope.errMsg = '没有相关数据';//商家列表无数据
        } else {
          $scope.errMsg = '';//商家列表有数据
        }
        if (tempList.length < params.pagesize) {
          isOver = true;//true:标志数据加载完成
          defer.resolve(isOver);
        } else {
          isOver = false;
          defer.resolve(isOver);
        }
        if (params.direction == 'down') {
          $scope.business = response.data.list;
        } else {
          $scope.business = $scope.business.concat(tempList);
        }

        ////判断是否为新品
        //$scope.isnew = function (value) {
        //  if (value == 'Y')
        //    return true;
        //  else
        //    return false;
        //};
        ////判断是否为爆品
        //$scope.ishot = function (value) {
        //  if (value == 'Y')
        //    return true;
        //  else
        //    return false;
        //};
      });
      return defer.promise;
    };

    /************************************** end ******************************************/

    /*********************************** 页面事件监听 *************************************/
    /**************关键字搜索*******************/
    var val = '';
    $scope.searchBusiness = function () {
      $scope.isSearch = false;
      $scope.busList = [];
      val = $('.search-input').val();
      $scope.business = [];
      $scope.params.pageno = '1';
      $scope.params.key = val;
      $scope.businessFun($scope.params);
    };
    //失去焦点，获取key的值
    $scope.supportBlur = function () {
      $scope.params.key = $('.search-input').val();
    };

    //点击按钮卡头更改服务id
    $scope.changeServiceTab = function (fuwu) {
      $scope.slides = "";
      $scope.params.fuwuType = '2';
      $scope.params.pageno = '1';
      $scope.params.city_fuwu_id = fuwu.city_fuwu_id;
      $scope.business = [];
      $scope.label = fuwu.label;   //卡头的label
      $scope.isShowPrompt = false;//提示信息默认不显示
      $scope.businessFun($scope.params);
      getAdverts(); //获得对应的轮播图
      getNotice(); //获得对应的跑马灯数据

      if (!fuwu.config) {
        $scope.isShowPrompt = true;
        getPrompt(fuwu.city_fuwu_id);//获得对应的城市服务提示
      } else {
        $scope.isShowPrompt = false;
      }
    };

    /**
     * 点击城市服务的提示，进入站点介绍
     */

    $scope.goStationIntro = function () {
      $state.go('member-about-stationintro');
    };

    //返回上一页
    $scope.backtocomservice = function () {
      $rootScope.supportTabIndex = null; //设置卡头所以为初始化
      $state.go('guanjia-comservice')
    };

    //点击商家，跳转到商品列表
    $scope.jumpgoodslist = function (businessId) {
      $state.go('guanjia-goodslist');
      var expireDate = new Date();
      expireDate.setDate(expireDate.getDate() + 30);
      var fuwu = $cookies.get('city_fuwu_id');
      if (null == businessId) {   //如果商家存在，说明不是从所有商家进去的，就清除city_fuwu—id
        $cookies.put('city_fuwu_id', $scope.params.city_fuwu_id, {'expires': expireDate.toUTCString()}); //存入当前城市的服务id
      } else {
        $cookies.remove('city_fuwu_id');
      }
      $cookies.put('businessId', businessId, {'expires': expireDate.toUTCString()});
    };

    /************************************** end ******************************************/
  }
);

//请求商家详情数据
guanjiaModuleController.controller(
  'sellerdetailCtrl',
  function ($scope, $stateParams, $rootScope, guanjiaService, userService, $state, $cookies) {
    $scope.businessId = $stateParams.businessId;
    guanjiaService.businessDetail({business_id: $scope.businessId}).success(function (response) {
      if (response.code == '0') {
        $scope.business = response.data;
        $scope.isShowOne = $scope.business.license.length > 0 || $scope.business.goods.length > 0 || $scope.business.location.length > 0 || $scope.business.work.length > 0;
      } else {
        console.log('请求商家详情接口有误！ ' + response.data);
      }
    });

  }
);

//商品列表
guanjiaModuleController.controller(
  'goodslistCtrl',
  function ($scope, $stateParams, $rootScope, guanjiaService, userService, $state, $q, $cookies, commonService, $timeout) {

    //from 判断从哪个页面跳转到此页
    // %fuli% 商家福利  %tegong%  特供服务
    $scope.from = $cookies.get('from');
    $scope.businessId = $cookies.get('businessId');
    $scope.city_fuwu_id = $cookies.get("city_fuwu_id");
    if ($scope.from == null || $scope.businessId == null && $scope.city_fuwu_id == null) $state.go('guanjia-comservice'); //如果cookie被清空

    //返回到商家列表
    $scope.backtosupport = function () {
      if ($scope.from == '%fuli%') {
        $state.go('welfare-seller');
      } else if ($scope.from == '%tegong%') {
        $state.go('guanjia-support');
      } else {    //如果参数被修改
        $state.go('guanjia-support');
      }
    };

    //获取公告数据
    guanjiaService.listNotice({
      type: 'business',
      business_id: $scope.businessId
    }).success(function (data) {
      $scope.marqueeContent = data.data;

      $.getScript('scripts/common/plugins/marquee.js', function () {
        createMarquee();
      });
    });

    //调用分类接口
    $scope.getCate = function () {
      var defer = $q.defer();
      guanjiaService.listCategory({
        business_id: $scope.businessId,
        city_fuwu_id: $scope.city_fuwu_id
      }).success(function (data) {
        if (data.code == '0') {
          $scope.category = data.data;
          $scope.category.unshift({category_id: '1', name: '全部'});
          defer.resolve($scope.category);
          //获取分类的index，保存在数组$scope.category_count中
          $scope.category_count = [];
          $.each($scope.category, function (index, info) {
            $scope.category_count.push(index);
          });
          //数值为$scope.category_count.length是全部
          $scope.category_count.push($scope.category_count.length);

          //默认加载全部的数据
          $scope.goodsListFun($scope.params);
        }

      });
      return defer.promise;
    };

    $scope.goodlistPromise = $scope.getCate();
    //商品列表
    $scope.direction = 'up';

    $scope.params = {
      business_id: $scope.businessId,
      city_fuwu_id: $scope.city_fuwu_id,
      pageno: '1', //页码
      pagesize: '10', //页数
      direction: $scope.direction,
      url: 'listGoods.action',
      category_id: null,
      sort: $scope.selected,
      key: ''
    };

    $scope.goodslist = [];
    var isOver = false;//false:标志数据未加载完成
    $scope.errMsg = '';
    $scope.goodsListFun = function (params) {
      var defer = $q.defer();
      userService.postRequestWithPageNo(params).success(function (response) {
        var tempList = response.data;
        if (tempList.length == 0 & params.pageno == '1') {
          $scope.errMsg = '没有相关数据';
        } else {
          $scope.errMsg = '';
        }
        if (tempList.length < params.pagesize) {
          isOver = true;//true:标志数据加载完成
          defer.resolve(isOver);
        } else {
          isOver = false;
          defer.resolve(isOver);
        }
        if (params.direction == 'down') {
          $scope.goodslist = response.data;
        } else {
          $scope.goodslist = $scope.goodslist.concat(tempList);
        }

        ////判断是否为新品
        //$scope.isnew = function (value) {
        //  if (value == 'Y')
        //    return true;
        //  else
        //    return false;
        //};
        ////判断是否为爆品
        //$scope.ishot = function (value) {
        //  if (value == 'Y')
        //    return true;
        //  else
        //    return false;
        //};
      });
      return defer.promise;
    };

    //排序
    $scope.changeSelected = function () {
      $scope.params.sort = $('.filter-block .dropdown').val();
      $scope.params.direction = 'down';
      $scope.goodsListFun($scope.params);
    };


    /***********************关键字搜索******************************************/
    var val = '';
    $scope.searchGoods = function () {
      val = $('.search-inpu').val();
      $scope.params.pageno = '1';
      $scope.goodslist = [];
      $scope.params.key = val;
      $scope.goodsListFun($scope.params);
    };
    //失去焦点，获取key的值
    $scope.goodsBlur = function () {
      $scope.params.key = $('.search-input').val();
    };

    //分类按钮的点击效果
    $scope.changecate = function (id, index) {
      if (id == '1') {
        $scope.index = $scope.category_count.length - 1;
        $scope.params.category_id = null;
      } else {
        $scope.index = index;
        $scope.params.category_id = id;
      }
      $scope.goodslist = [];
      $scope.params.pageno = '1';
      $scope.goodsListFun($scope.params);
    };
    //商家详情
    guanjiaService.businessDetail({business_id: $scope.businessId}).success(function (data) {

      $scope.business = data.data;
    });
    //跳转到卖家详情
    $scope.jumpSellerdetail = function () {
      $state.go('guanjia-sellerdetail', {businessId: $scope.businessId});
    };
    //跳转到购买页面
    $scope.jumppurchase = function (id) {
      localStorage.goodsId = id;
      sessionStorage.station_id = "";
      $state.go('service-purchase', {
        operate: 112,
        obj: {}
      });
      $cookies.put('tab', '?list%');
    };
    //跳转到商品详情
    $scope.jumpgoodsDetail = function (id) {
      $state.go('service-goodsDetail');
      localStorage.goodsId = id;
    }
  }
);

guanjiaModuleController.controller(
  'payCtrl',
  function ($scope, $stateParams, guanjiaService, userService, $state, commonService, $timeout, $cookies, payCacheService, $rootScope) {

    $scope.orderSumPay = 0;
    $scope.needsPay = 0;
    /*
     *@params:from 判断页面从哪儿跳转来
     * from = 1; 从购物车下单成功后跳转
     * from = 2; 从我的订单-未支付订单选择支付跳转
     * from = 3; 从我的购买页直接支付跳转
     * from = 4; 从订单详情页选择支付跳转
     *
     * from = 10 ;从第三方支付平台点击程序内部的返回按钮返回
     */
    var from = $stateParams.from;
    var orderIds;
    //从购物车来支付
    if (from == 1 || sessionStorage.isFrom == 1) {
      orderIds = payCacheService.getProperty("orderId");
    }
    //我的订单来支付
    if (from == 2 || sessionStorage.isFrom == 2) {
      orderIds = payCacheService.getProperty('orderId');
    }
    //从购买页来支付
    if (from == 3 || sessionStorage.isFrom == 3) {
      orderIds = payCacheService.getProperty("orderId");

    }
    //订单详情
    if (from == 4 || sessionStorage.isFrom == 4) {
      orderIds = payCacheService.getProperty('orderId');
    }
    //在第三方支付平台点击程序内部的返回按钮
    if (from == 10) {
      orderIds = payCacheService.getProperty("orderId");
    }

    var params = {json: JSON.stringify(orderIds)};
    //请求用户订单
    userService.postRequestWithUrlAndParams("getOrderByPay.action", params).success(function (response) {
      if (response.code == 0) {
        //订单列表
        $scope.orderList = response.data.order;
        var sunTmp = 0.0;
        for (var index = 0; index < $scope.orderList.length; index++) {
          var orderPrice = parseFloat($scope.orderList[index].sum);
          sunTmp += orderPrice;
        }
        $scope.orderSumPay = sunTmp;

        var balance = response.data.balance;

        //用户的账户余额
        $scope.userBanlance = balance;
        //用户账户余额输入框中的数字
        $scope.banlancePaid = $scope.orderSumPay < $scope.userBanlance ? $scope.orderSumPay : $scope.userBanlance;

        //需付金额
        $scope.needsPay = $scope.orderSumPay - $scope.banlancePaid;

        //支付方式列表,默认选中第一个
        $scope.paymentTypeList = response.data.payment;
        $timeout(function () {
          if ($scope.paymentTypeList.length) {
            var payTypeList = $('.pay-paytype').find('.choosePaymentPlatform');
            var fisrtPayType = payTypeList[0];
            $(fisrtPayType).attr('checked', true);
          }
        }, 200);

      }
      if (response.code == -1) {
        commonService.showErrorMessage("参数为空");
      }
      if (response.code == -2) {
        commonService.showErrorMessage("参数错误");
      }

      //待页面加载完成之后再寻找对应的留言框
      $timeout(function () {
        var balanceUsed = payCacheService.getProperty("balanceUsed");
        var orders = payCacheService.getProperty("orders");
        var paySelectedPayId = payCacheService.getProperty("paySelectedPayId");
        if (balanceUsed != undefined && balanceUsed != null) {
          $scope.banlancePaid = balanceUsed
          //需付金额
          $scope.needsPay = $scope.orderSumPay - $scope.banlancePaid;
        }
        if (orders != undefined && orders != null) {
          var remarkDivs = $('.order-table').find('.remark-field');
          for (var index = 0; index < orders.length; index++) {
            var order = orders[index];
            var remarkDiv = remarkDivs[index];
            var remarkText = order.remark == undefined || order.remark == null ? "" : order.remark;
            $(remarkDiv).val(remarkText);
          }
        }


        //默认选中上次用户跳转之前选中的支付方式
        var payTypeList = $('.pay-paytype').find('.choosePaymentPlatform');
        for (var index = 0; index < payTypeList.length; index++) {
          var paymentPlatform = payTypeList[index];
          if ($(paymentPlatform).val() == paySelectedPayId) {
            $(paymentPlatform).attr('checked', true);
          }

        }

        //清除掉缓存的数据
        payCacheService.setProperty("balanceUsed", undefined);        //清除输入框中的账户余额使用金额
        payCacheService.setProperty("orders", undefined);             //清除订单数据
        payCacheService.setProperty("paySelectedPayId", undefined);   //清除选择的支付方式
      }, 200)


    }).error(function (data, status, header, config) {

    });


    //余额输入框失去焦点
    $scope.losefocus = function (obj) {

      //总的支付金额 < 账户余额，如果输入框中的输入的金额大于总的支付金额就自动置为总的支付金额
      if ($scope.orderSumPay < $scope.userBanlance) {
        if ($scope.banlancePaid > $scope.orderSumPay) {
          $scope.banlancePaid = $scope.orderSumPay
        }
      } else {
        //总的支付金额 > 账户余额，如果输入框中的输入金额大于了账户余额，那么自动将输入的金额置为账户余额
        if ($scope.banlancePaid > $scope.userBanlance) {
          $scope.banlancePaid = $scope.userBanlance
        }
      }

      //需付金额
      $scope.needsPay = $scope.orderSumPay - $scope.banlancePaid;

    }

    //请求接口获取使用优惠券后应该支付的总金额
    function getTotalPriceToPay() {
      var orderArray = [];
      var orderList = $('.list-group').find('.pay-order-row');
      for (var index = 0; index < orderList.length; index++) {
        var orderId = $(orderList[index]).find('.pay-order-id').html();

        var couponsArray = [];
        var couponsList = $(orderList[index]).find('.coupons-table-row');
        for (var i = 0; i < couponsList.length; i++) {
          var couponsName = $(couponsList[i]).find('.pay-coupons-name').html();
          var couponsSize = $(couponsList[i]).find('.numbermodify-number').val();

          if (couponsSize != '0') {
            var couponsDict = {};
            couponsDict['name'] = couponsName;
            couponsDict['size'] = couponsSize;
            couponsArray.push(couponsDict);
          }

        }


        var orderCouponsDict = {};
        orderCouponsDict['order_id'] = orderId;
        orderCouponsDict['coupons'] = couponsArray;
        orderArray.push(orderCouponsDict);
        //if(couponsArray.length){
        //}

      }
      var params = {
        mobile: localStorage.mobile,
        json: JSON.stringify(orderArray)
      };
      userService.postRequestWithUrlAndParams('getOrderByCoupons.action', params).success(function (response) {
        if (response.code == '0') {
          $scope.needsPay = 0;
          $.each(response.data, function (index, info) {
            $scope.needsPay += info.sum;
          });
        }
      });
    }


    //减少优惠券的使用数量
    $scope.minusCouponsNumberAction = function ($event) {
      var elem = $($event.target).next();
      var val = parseFloat(elem.val());
      if (val > 0) {
        elem.val(--val);

        getTotalPriceToPay();


        //找到点击的优惠券对应的可以使用的商品
        //var couponsUsedGoodsIdList = [{'goods_id': '402880ec54a953370154a955fa390003', 'goods_price': '1'}]
        //var goodsList = $('.pay-goods-table').find('.pay-goods-row')
        //var couponsUsed = {};
        //for (var i = 0; i < goodsList.length; i++) {
        //
        //  var goodsId = $(goodsList[i]).find('.pay-goods-id').html();
        //
        //  var goodsPrice = []
        //  for (var j = 0; j < couponsUsedGoodsIdList.length; j++) {
        //
        //    var couponsGoodsId = couponsUsedGoodsIdList[j]['goods_id'];
        //    //找到对应的商品，记录商品的价格以及优惠券的金额
        //    if (goodsId == couponsGoodsId) {
        //      goodsPrice.push(couponsUsedGoodsIdList[j]['goods_price']);
        //    }
        //
        //  }
        //
        //  if (goodsPrice.length > 0) {
        //    couponsUsed["couponsSum"] = couponsDiscount;
        //    couponsUsed["couponsType"] = couponsType;
        //    couponsUsed["goodsPriceList"] = goodsPrice;
        //  }
        //}

        //如果是抵数，那么直接找到对应的最大价值的商品
        //var goodsPriceList = couponsUsed["goodsPriceList"];
        //if(goodsPriceList){
        //  //找出该优惠券对应的商品中价值最大的商品
        //  //1.先判断该优惠券是否是抵数
        //  if (couponsType == '抵数') {
        //    if (goodsPriceList.length == 1) {
        //      var price = goodsPrice[0]; //取出商品的价格，从总价格中减去
        //      $scope.needsPay = $scope.needsPay - price >= 0 ? $scope.needsPay - price : 0;
        //    } else {
        //      //找出最大价值的商品价格
        //      var max = Math.max.apply(Math, goodsPriceList);
        //      $scope.needsPay = $scope.needsPay - max >= 0 ? $scope.needsPay - max : 0;
        //    }
        //
        //  } else if (couponsType == '现金') {
        //
        //    //找出最大价值的商品价格
        //    var max = Math.max.apply(Math, goodsPriceList);
        //    //比较商品价格与优惠券可以抵扣的价格
        //    if (parseInt(couponsDiscount) > parseInt(max)){
        //      //如果优惠券抵消额比商品价格高，那么减去商品的价格
        //      $scope.needsPay = $scope.needsPay - max >= 0 ? $scope.needsPay - max : 0;
        //    }else{
        //      //如果优惠券的抵消额比商品的价格低，那么减去优惠券的价格
        //      $scope.needsPay = $scope.needsPay - parseInt(couponsDiscount) >= 0 ? $scope.needsPay - parseInt(couponsDiscount) : 0;
        //    }
        //
        //  }else if(couponsType == '折扣'){
        //    //找出最大价值的商品价格
        //    var max = Math.max.apply(Math, goodsPriceList);
        //    $scope.needsPay =  $scope.needsPay * parseFloat(couponsDiscount).toFixed(2);
        //
        //  }
        //}
      }
    }

    //增加优惠券的使用数量
    $scope.addCouponsNumberAction = function ($event) {
      var elem = $($event.target).prev();
      var val = parseFloat(elem.val());

      //获取当前增加优惠券的类型(现金、打折、抵数)
      var couponsType = $($event.target).parent().parent().find('.pay-coupons-info').find('.pay-coupons-type').html();
      //获取当前增加优惠券的金额(现金数、折扣数、抵数)
      var couponsDiscount = $($event.target).parent().parent().find('.pay-coupons-info').find('.pay-coupons-discount').html();
      //获取当前增加优惠券的名称
      var couponsName = $($event.target).parent().parent().find('.pay-coupons-info').find('.pay-coupons-name').html();
      //获取该类型优惠券的总数量
      var couponsNum = $($event.target).parent().parent().find('.pay-coupons-info').find('.pay-coupons-num').html();
      couponsNum = parseInt(couponsNum);
      //获取该优惠券当前已选择的数量
      var couponsUsedNum = $($event.target).parent().find('.numbermodify-number').val();

      console.log("点击优惠券的类型  ：" + couponsType);
      console.log("点击优惠券的折扣数：" + couponsDiscount);
      console.log("点击优惠券的名称  ：" + couponsName);
      console.log("点击优惠券的总数量：" + couponsNum);

      var couponsEnabledUseNum = 0;
      //循环遍历，找到该优惠券其他订单下的使用情况
      var payOrderRowList = $('.order-table').find('.pay-order-row');


      for (var index = 0; index < payOrderRowList.length; index++) {
        //console.log(payOrderRowList[index])
        var couponsRowList = $(payOrderRowList[index]).find('.coupons-table-row');
        for (var i = 0; i < couponsRowList.length; i++) {

          var showCouponsType = $(couponsRowList[i]).find('.pay-coupons-type').html();
          var showCouponsDiscount = $(couponsRowList[i]).find('.pay-coupons-discount').html();
          var showCouponsName = $(couponsRowList[i]).find('.pay-coupons-name').html();

          if (showCouponsType == couponsType && showCouponsDiscount == couponsDiscount && couponsName == showCouponsName) {
            var showCouponsUsedNum = $(couponsRowList[i]).find('.numbermodify-number').val();
            showCouponsUsedNum = parseInt(showCouponsUsedNum);
            //console.log("使用数量     ：" + couponsUsedNum);
            //console.log("显示的使用数量：" + showCouponsUsedNum);
            couponsEnabledUseNum += showCouponsUsedNum;
            //console.log("总的使用数量  ：" + couponsUsedNum);
          }

        }

      }

      //找到当前选择增加的优惠券的数量

      var couponsMaxNum = couponsNum - couponsEnabledUseNum + parseInt(couponsUsedNum);
      console.log("可添加最大数：" + couponsMaxNum);


      if (val < couponsMaxNum) {
        elem.val(++val);

        getTotalPriceToPay();
        //找到点击的优惠券对应的可以使用的商品,并且和该订单下的商品列表中的商品进行比较
        //var couponsUsedGoodsIdList = $($event.target).parent().find('.pay-coupons-goodsIdList').html()
        ////var couponsUsedGoodsIdList = [{'goods_id': '402880ec54a953370154a955fa390003', 'goods_price': '1'}]
        //var goodsList = $($event.target).parent().parent().parent().parent().parent().find('.pay-goods-row')
        //console.log("**********************")
        //console.log(couponsUsedGoodsIdList);
        //console.log("**********************")
        //var couponsUsed = {};
        //for (var i = 0; i < goodsList.length; i++) {
        //
        //  var goodsId = $(goodsList[i]).find('.pay-goods-id').html();
        //
        //  var goodsPrice = []
        //  for (var j = 0; j < couponsUsedGoodsIdList.length; j++) {
        //
        //    var couponsGoodsId = couponsUsedGoodsIdList[j]['goods_id'];
        //
        //    //找到对应的商品，记录商品的价格以及优惠券的金额
        //    if (goodsId == couponsGoodsId) {
        //      goodsPrice.push(couponsUsedGoodsIdList[j]['goods_price']);
        //    }
        //
        //  }
        //
        //  if (goodsPrice.length > 0) {
        //    couponsUsed["couponsSum"] = couponsDiscount;
        //    couponsUsed["couponsType"] = couponsType;
        //    couponsUsed["goodsPriceList"] = goodsPrice;
        //  }
        //}


        //var goodsPriceList = couponsUsed["goodsPriceList"];
        //console.log(goodsPriceList);
        ////当优惠券商品列表中没有商品可以优惠时(这种情况一般不会出现)
        //if(goodsPriceList){
        ////  找出该优惠券对应的商品中价值最大的商品
        //  //1.先判断该优惠券是否是抵数
        //  if (couponsType == '抵数') {
        //    //如果是抵数，那么直接找到对应的最大价值的商品
        //
        //    //if (goodsPriceList.length == 1) {
        //    //  var price = goodsPrice[0]; //取出商品的价格，从总价格中减去
        //    //  $scope.needsPay = $scope.needsPay - price >= 0 ? $scope.needsPay - price : 0;
        //    //} else {
        //    //  //找出最大价值的商品价格
        //    //  var max = Math.max.apply(Math, goodsPriceList);
        //    //  $scope.needsPay = $scope.needsPay - max >= 0 ? $scope.needsPay - max : 0;
        //    //}
        //
        //    //找出最大价值的商品价格
        //    var max = Math.max.apply(Math, goodsPriceList);
        //    $scope.needsPay = $scope.needsPay - max >= 0 ? $scope.needsPay - max : 0;
        //
        //  } else if (couponsType == '现金') {
        //
        //    //找出最大价值的商品价格
        //    var max = Math.max.apply(Math, goodsPriceList);
        //    //比较商品价格与优惠券可以抵扣的价格
        //    if (parseInt(couponsDiscount) > parseInt(max)){
        //      //如果优惠券抵消额比商品价格高，那么减去商品的价格
        //      $scope.needsPay = $scope.needsPay - max >= 0 ? $scope.needsPay - max : 0;
        //    }else{
        //      //如果优惠券的抵消额比商品的价格低，那么减去优惠券的价格
        //      $scope.needsPay = $scope.needsPay - parseInt(couponsDiscount) >= 0 ? $scope.needsPay - parseInt(couponsDiscount) : 0;
        //    }
        //
        //  }else if(couponsType == '折扣'){
        //    //找出最大价值的商品价格
        //    var max = Math.max.apply(Math, goodsPriceList);
        //    $scope.needsPay =  $scope.needsPay * parseFloat(couponsDiscount).toFixed(2);
        //
        //  }
        //}

      }


    }


    //前往支付
    $scope.payAction = function () {

      //获取优惠券的使用情况
      //var orderCouponsInfoList = [];
      //
      //var couponseUsedList = $('.list-group').find('.pay-order-row');
      //
      //for (var index = 0; index < couponseUsedList.length; index++) {
      //
      //  //订单号
      //  var orderId = $(couponseUsedList[index]).find('.pay-order-id').html();
      //  var remark = $(couponseUsedList[index]).find('.remark-field').html();
      //
      //  var goodsIdArray = [];
      //  var goodsDivArray = $(couponseUsedList[index]).find('.pay-goods-row');
      //
      //  for (var i = 0 ; i < goodsDivArray.length;i++){
      //    var goodsDiv = goodsDivArray[i];
      //    var goodsIdDivArray = $('.pay-goods-row').find('.pay-goods-id');
      //    console.log(goodsIdDivArray);
      //    var goodsId = $(goodsIdDivArray[0]).html();
      //    console.log(goodsId);
      //    goodsIdArray.push(goodsId);
      //  }
      //
      //
      //  var order = {"order_id": orderId, "remark": remark,"order_item":goodsIdArray};
      //  orderCouponsInfoList.push(JSON.stringify(order));

      //找到优惠券的使用
      //var couponsInfoList = [];
      //var couponsUsedList = $(couponseUsedList[index]).find('.coupons-table').find('.coupons-table-row');
      //for (var i = 0; i < couponsUsedList.length; i++) {
      //
      //  //获取优惠券的id以及使用的数量
      //  var couponsUsedId = "123456";
      //  var couponsUsedNum = $(couponseUsedList[i]).find('.numbermodify-number').val(); //优惠券使用数量
      //  var couponsUsedType = $(couponseUsedList[i]).find('.pay-coupons-type').html();  //优惠券类型
      //  var couponsUsedDiscount = $(couponseUsedList[i]).find('.pay-coupons-discount').html();  //优惠券金额
      //
      //  //当选择使用了优惠券
      //  if(couponsUsedNum){
      //    var couponsInfo = {};
      //    couponsInfo['id'] = couponsUsedId;
      //    couponsInfo['count'] = couponsUsedNum;
      //    couponsInfo['type'] = couponsUsedType;
      //    couponsInfo['number'] = couponsUsedDiscount;
      //
      //    couponsInfoList.push(couponsInfo);
      //  }
      //}

      //var orderCouponsInfo = {};
      //orderCouponsInfo['no'] = orderNo;
      //orderCouponsInfo['coupons'] = couponsInfoList;
      //orderCouponsInfoList.push(orderCouponsInfo);
      //}

      var orderArray = [];
      var orderList = $('.list-group').find('.pay-order-row');
      for (var index = 0; index < orderList.length; index++) {
        var orderId = $(orderList[index]).find('.pay-order-id').html();
        var remark = $(orderList[index]).find('.remark-field').val();

        //获取优惠券的使用状况
        var couponsArray = [];
        var couponsList = $(orderList[index]).find('.coupons-table-row');
        for (var i = 0; i < couponsList.length; i++) {
          var couponsName = $(couponsList[i]).find('.pay-coupons-name').html();
          var couponsSize = $(couponsList[i]).find('.numbermodify-number').val();

          if (couponsSize != '0') {
            var couponsDict = {};
            couponsDict['name'] = couponsName;
            couponsDict['size'] = couponsSize;
            couponsArray.push(couponsDict);
          }

        }


        //获取商品id
        var goodsIdArray = [];
        var goodsDivArray = $(orderList[index]).find('.pay-goods-row');
        for (var i = 0; i < goodsDivArray.length; i++) {
          var goodsDiv = goodsDivArray[i];
          var goodsIdDivArray = $(goodsDiv).find('.pay-goods-orderitem-id');
          var goodsId = $(goodsIdDivArray[0]).html();
          goodsIdArray.push(goodsId);
        }

        var orderCouponsDict = {};
        orderCouponsDict['order_id'] = orderId;
        orderCouponsDict['coupons'] = couponsArray;
        orderCouponsDict['remark'] = remark;
        orderCouponsDict['orderItem_id'] = goodsIdArray;
        orderArray.push(orderCouponsDict);
      }

      /*
       * sessionStorage.isFrom 表征从那个页面到支付页，方便后台在支付成功后跳转到相应的页面
       * value =  1 购物车
       * value =  2 订单列表
       * value =  3 购买页（商品列表、商品详情）
       * value =  4 订单详情
       */
      var from = sessionStorage.isFrom == 1 ? 'cart' : (sessionStorage.isFrom == 3 ? 'goods' : 'order');

      //获取用户选择的支付方式
      var paySelectedPayId = $('input:radio:checked').val(); //支付方式id
      var params = {
        mobile: localStorage.mobile,
        "payment_id": paySelectedPayId,
        "json": JSON.stringify(orderArray),
        "balanceUsed": $scope.banlancePaid,
        'from': from
      };


      //支付
      userService.postRequestWithUrlAndParams("pay.action", params).success(function (response) {

        payCacheService.setProperty("orderId", orderIds);
        payCacheService.setProperty("orders", orderArray);
        payCacheService.setProperty("balanceUsed", $scope.banlancePaid);
        payCacheService.setProperty("paySelectedPayId", paySelectedPayId);

        var resType = typeof response;
        if (resType == 'object') {
          commonService.showErrorMessage(response.data);
        } else {
          sessionStorage.alipayHtml = response;
          $state.go("ali-pay");
        }


      }).error(function (data, status, header, config) {
        console.log("支付出错");
      });


    }

    //返回按钮点击
    $scope.back = function () {
      if (from == 1 || sessionStorage.isFrom == 1) {
        $state.go("member-user-cart");
      }
      if (from == 2 || sessionStorage.isFrom == 2) {
        $state.go("member-user-myorder", {"from": 1});
      }
      if (from == 3 || sessionStorage.isFrom == 3) {
        localStorage.toPurchase = 4;
        $state.go("service-purchase", {"operate": 4, obj: {}});
      }
      if (from == 4 || sessionStorage.isFrom == 4) {
        $state.go('member-user-orderdetail', {orderId: payCacheService.getProperty('detailOrderId')});
      }

    };

  });


//在线超市
guanjiaModuleController.controller('shoppingCtrl', ['$scope', 'guanjiaService', '$sce', '$cookies', '$state', '$q', function ($scope, guanjiaService, $sce, $cookies, $state, $q) {
  function getListMarket() {
    var defer = $q.defer();
    guanjiaService.listMarket().success(function (response) {
      if (response.code == '0') {
        if (response.data != null && response.data.length > 0) {
          $scope.segItems = response.data;
          defer.resolve($scope.segItems);
          $scope.currentShowMarketUrl = $sce.trustAsResourceUrl(response.data[0].url);
        }
        $scope.marketShow = function (item) {
          $scope.currentShowMarketUrl = $sce.trustAsResourceUrl(item.url);
        };
      }
    });
    return defer.promise;
  };
  $scope.shoppingPromise = getListMarket();

  $scope.record = function (mId) {
    if ($cookies.get('ticket')) {
      guanjiaService.recordMarket({
        market_id: mId
      }).success(function (response) {
        console.log(response.code);
      });
    }
  };

  //返回
  $scope.goBack = function () {
    $state.go('guanjia-comservice');
  }

}]);

//支付页面
guanjiaModuleController.controller('alipayCtrl', ['$scope', 'guanjiaService', '$sce', '$stateParams', '$state', '$cookies', function ($scope, guanjiaService, $sce, $stateParams, $state, $cookies) {

  //$scope.alipayHtml = sessionStorage.alipayHtml;
  console.log(sessionStorage.alipayHtml)
  $(".alipay-html").html(sessionStorage.alipayHtml);

  $scope.backPay = function () {
    $state.go('guanjia-pay', {from: 10, obj: {}});
  }

}]);

//家庭服务
guanjiaModuleController.controller('familyserviceCtrl', ['$scope', 'guanjiaService', 'commonService', '$q', 'userService', '$state', '$cookies', '$stateParams', '$rootScope', function ($scope, guanjiaService, commonService, $q, userService, $state, $cookies, $stateParams, $rootScope) {
  //获取当前城市
  //$scope.city_name = sessionStorage.gpscityName;
  $scope.imgShow = true;
  $scope.myInterval = 3000; //设置轮播图的图片切换时间
  $scope.from = $stateParams.from; //from  0:家庭服务  1:干洗到家
  var tabIndex = $rootScope.supportTabIndex;
  //$scope.errMsg = '没有相关数据';
  $scope.familyserviceContent = true;
  function getCityService() {
    var defer = $q.defer();
    $scope.tabCount = [];//存放选项卡index
    guanjiaService.listCityService({
      city_id: sessionStorage.gpscityId,
      type: '家庭服务'
    }).success(function (response) {
      if (response.data.length > 0 && response.code == '0') {
        $scope.familyserviceContent = true;//有城市服务数据
        $scope.serviceType = response.data;
        defer.resolve($scope.serviceType);
        //获取服务id和index分别存入数组$scope.fuwu和tabCount
        $scope.fuwu = [];
        $scope.tabCount = [];
        $.each($scope.serviceType, function (index, info) {
          $scope.tabCount.push(index);
          $scope.fuwu.push(info.city_fuwu_id);
        });

        if ($scope.from != '1') {             //不是从热门服务进来的
          var intiInde = null == tabIndex ? 0 : tabIndex;
          $scope.businessParams.city_fuwu_id = $scope.serviceType[intiInde].city_fuwu_id;
          //请求分类完成之后获取选择的分类的商家数据（初始化页面的时候默认选择第一个分类）
          $scope.label = $scope.serviceType[intiInde].label;
          getAdverts();   //轮播图
          getNotice();    //公告

          if ($scope.serviceType[intiInde] == 0) {
            $scope.isShowPrompt = true;
            getPrompt($scope.serviceType[intiInde].city_fuwu_id); //提示
          } else {
            $scope.isShowPrompt = false;
          }

        } else if ($scope.from == '1') {      //否则按是处理
          $scope.drycleanFuwu_id = $rootScope.hotFuwu_id;
          $scope.businessParams.city_fuwu_id = $scope.drycleanFuwu_id;


          // 早餐所对应的index
          $.each($scope.fuwu, function (i, value) {
            if (value == $scope.drycleanFuwu_id) {
              $scope.drycleanIndex = i;
            }
          });

          getAdverts();
          getNotice();
          if ($scope.serviceType[$scope.drycleanIndex].config == 0) {
            $scope.isShowPrompt = true;
            getPrompt($scope.serviceType[$scope.drycleanIndex].city_fuwu_id);
          } else {
            $scope.isShowPrompt = false;
          }

        }


        $scope.business_family = [];
        $scope.businessLis($scope.businessParams);
      } else {//无数据
        $scope.familyserviceContent = false;//无城市服务数据
      }
    });
    return defer.promise;
  }

  //动态获取选项卡和商家数据
  $scope.service_promise = getCityService();
  /*****************获取商家列表*****************************************/
    //获取服务商家列表
  $scope.businessParams = {
    city_id: sessionStorage.gpscityId,
    city_fuwu_id: "",
    pageno: '1', //页码
    pagesize: '10', //页数
    url: 'listBusiness.action',
    direction: 'up',
    key: ''
  };
  $scope.business_family = [];
  var isOver = false; //false:标志数据未加载完成
  $scope.familyserviceList = true;
  $scope.businessLis = function (params) {
    var defer = $q.defer();
    userService.postRequestWithPageNo(params).success(function (response) {
      var tempList = response.data.list;
      $scope.allBusiness = response.data;
      if (tempList.length == 0 && params.pageno == '1') {
        $scope.familyserviceList = false;//无商家列表数据
      } else {
        $scope.familyserviceList = true;//有商家列表数据
      }
      if (tempList.length < params.pagesize) {
        isOver = true;//true:标志数据加载完成
        defer.resolve(isOver);
      } else {
        isOver = false;
        defer.resolve(isOver);
      }
      if (params.direction == 'down') {
        $scope.business_family = tempList;
      } else {
        $scope.business_family = $scope.business_family.concat(tempList);
      }

    });
    return defer.promise;
  };

  /*************************************页面事件监听******************************************/

  $scope.goStationIntro = function () {
    $state.go('member-about-stationintro');
  };
  //点击选项卡，切换内容
  $scope.change_tab = function (fuwu) {
    $scope.slides = "";
    $scope.businessParams.city_fuwu_id = fuwu.city_fuwu_id;
    $scope.business_family = [];
    $scope.label = fuwu.label; //设置等于卡头的label
    $scope.isShowPrompt = false;
    $scope.businessLis($scope.businessParams);
    getAdverts();
    getNotice();
    if (!fuwu.config) {
      $scope.isShowPrompt = true;
      getPrompt(fuwu.city_fuwu_id);
    } else {
      $scope.isShowPrompt = false;
    }

  };

  /**
   * 关键字搜索
   * @type {boolean}
   */
  var val = '';
  //点击关键字搜索按钮
  $scope.searchFamilyBusiness = function () {
    $scope.business_family = [];
    val = $('.search-input').val();
    $scope.businessParams.pageno = '1';
    $scope.businessParams.key = val;
    $scope.businessLis($scope.businessParams);
  };
  //失去焦点，获取key的内容
  $scope.serviceBlur = function () {
    $scope.businessParams.key = $('.search-input').val();
  };

  //点击返回按钮
  $scope.goBack = function () {
    $state.go('guanjia-comservice');
    $rootScope.supportTabIndex = null;
  };

  /*************************************   end   ******************************************/
    //点击商家，跳转到服务列表页
    //$scope.goServiceList = function (businessId, businessName) {
    //  $state.go('guanjia-familyservicelist', {
    //    businessId: businessId,
    //    businessName: businessName
    //  });
    //  sessionStorage.businessId = businessId;
    //  sessionStorage.businessName = businessName;
    //};


  $scope.goServiceList = function (businessId) {
    $state.go('guanjia-familyservicelist');
    var expireDate = new Date();
    expireDate.setDate(expireDate.getDate() + 30);
    if (null == businessId) {
      $cookies.put('city_fuwu_id', $scope.businessParams.city_fuwu_id, {'expires': expireDate.toUTCString()}); //存入当前城市的服务id
    } else {  //如果商家存在，说明不是从所有商家进去的，就清除city_fuwu—id
      $cookies.remove('city_fuwu_id');
    }
    //存放商家ID
    $cookies.put('businessId', businessId, {'expires': expireDate.toUTCString()});
  };


  /**************************************初始化轮播图，跑马灯，提示数据***************************************/


  /**
   * 广告轮播图
   */
  function getAdverts() {
    var promise = guanjiaService.getAdverts($scope.label);
    promise.then(function (data) {
      if (data != null && data.length > 0) {
        $scope.slides = data;
        //轮播图请求到数据1秒后显示
        setTimeout(function () {
          $scope.imgShow = false;
        }, 1000);
      } else {
        $scope.slides = null;
      }
    });
  }


  /**
   *  获取公告数据
   */
  function getNotice() {
    var noticeParams = {
      type: 'system,city',
      city_id: sessionStorage.gpscityId,
      label: $scope.label
    };
    guanjiaService.getNotice(noticeParams).then(function (data) {
      if (data != null && data.length > 0) {
        var marqueeContent = '';
        for (var i = 0; i < data.length; i++) {
          marqueeContent += '<li>' + data[i].content + '<li>';
        }
        marqueeContent = "<marquee behavior='scroll'  scrollAmount='" + $scope.slide + "'>" +
          "<ul class='list-inline'>" + marqueeContent + "</ul></marquee>";
        $('.marquee-broadcast').html(marqueeContent);
        $('.marquee-broadcast').css('display', 'block');
      } else {
        $('.marquee-broadcast').css('display', 'none');
      }
    }, function (err) {
      commonService.showErrorMessage("请求错误！");
    });
  }

  /**
   * 获取城市服务提示数据
   */
  function getPrompt(fuwu_id) {
    var params = {
      fuwu_id: fuwu_id
    };
    guanjiaService.getCityServicePrompt(params).then(function (reponse) {
      if (reponse.data != null) {
        switch (reponse.data.code) {
          case '0':
            $scope.promptData = reponse.data.data;
            break;
          case '1':
            commonService.showErrorMessage("参数为空!");
            break;
          case '2':
            commonService.showErrorMessage("参数错误!");
            break;
        }
      }
    }, function (error) {
      commonService.showErrorToast("请求错误,请稍后再试~")
    });
  }

  /****************************************  end  ****************************************************/

}]);
//服务列表
guanjiaModuleController.controller('familyservicelistCtrl', ['$scope', '$stateParams', 'guanjiaService', '$q', 'userService', 'commonService', '$state', '$cookies', function ($scope, $stateParams, guanjiaService, $q, userService, commonService, $state, $cookies) {

  //from 判断从哪个页面跳转到此页
  // %fuli% 商家福利  %tegong%  特供服务
  $scope.from = $cookies.get('from');
  $scope.businessId = $cookies.get('businessId');
  $scope.city_fuwu_id = $cookies.get("city_fuwu_id");
  if ($scope.from == null || $scope.businessId == null && $scope.city_fuwu_id == null)
    $state.go('guanjia-comservice'); //如果cookie被清

  //商家详情
  guanjiaService.businessDetail({business_id: $scope.businessId}).success(function (data) {
    $scope.business = data.data;
  });


  //返回到商家列表
  $scope.backtosupport = function () {
    $state.go('guanjia-familyservicelist');
  };

  //获取公告数据
  guanjiaService.listNotice({
    type: 'business',
    business_id: $scope.businessId
  }).success(function (data) {
    $scope.marqueeContent = data.data;

    $.getScript('scripts/common/plugins/marquee.js', function () {
      createMarquee();
    });
  });

  //获取商品分类
  function getCategory() {
    $scope.serviceCount = [];//存放商品分类index
    var defer = $q.defer();
    guanjiaService.listCategory({
      business_id: $scope.businessId,
      city_fuwu_id: $scope.city_fuwu_id
    }).success(function (response) {
      if (response.code == '0') {
        $scope.categoryLis = response.data;
        $scope.categoryLis.unshift({category_id: '1', name: '全部'});
        defer.resolve($scope.categoryLis);
        $.each($scope.categoryLis, function (index, info) {
          $scope.serviceCount.push(index);
        });
        //数值为$scope.categoryLis.length表示全部
        $scope.serviceCount.push($scope.categoryLis.length);
        //默认加载全部商品列表
        $scope.serviceListParams.sort = $scope.selected;
        $scope.serviceList = [];
        $scope.serviceListFun($scope.serviceListParams);
      } else {
        console.log('获取商品分类失败!');
      }
    });
    return defer.promise;
  }

  $scope.promised = getCategory();

  //点击分类按钮
  $scope.showCtagoryContent = function (index, cateId) {
    if (cateId == '1') {
      $scope.index = $scope.categoryLis.length;
      $scope.serviceListParams.category_id = null;
    } else {
      $scope.index = index;
      $scope.serviceListParams.category_id = cateId;
    }
    $scope.serviceListParams.sort = $scope.selected;
    $scope.serviceList = [];
    $scope.serviceListFun($scope.serviceListParams);
  };

  $scope.serviceListParams = {
    business_id: $scope.businessId,
    city_fuwu_id: $scope.city_fuwu_id,
    pageno: '1', //页码
    pagesize: '10', //页数
    direction: 'up',
    url: 'listGoods.action',
    category_id: null,
    sort: null,
    key: ''
  };
  $scope.serviceList = [];
  var isOver = false;//false:标志数据未加载完成
  $scope.errMsg = '';
  $scope.serviceListFun = function (params) {
    var defer = $q.defer();
    userService.postRequestWithPageNo(params).success(function (response) {

      var tempList = response.data;
      if (tempList.length == 0 && params.pageno == '1') {
        $scope.errMsg = '没有相关数据';
      } else {
        $scope.errMsg = '';
      }
      if (tempList.length < params.pagesize) {
        isOver = true;//true:标志数据加载完成
        defer.resolve(isOver);
      } else {
        isOver = false;
        defer.resolve(isOver);
      }

      if (params.direction == 'down') {
        $scope.serviceList = response.data;
      } else {
        $scope.serviceList = $scope.serviceList.concat(tempList);
      }
    });
    return defer.promise;
  };

  //选择下拉列表选项
  $scope.changeSort = function () {
    $scope.serviceListParams.sort = $scope.selected;
    $scope.serviceListParams.direction = 'down';
    $scope.serviceList = [];
    $scope.serviceListFun($scope.serviceListParams);
  };


  /*****************关键字搜索**************************************/
  var val = '';
  $scope.searchServiceList = function () {
    val = $('.search-input').val();
    $scope.serviceList = [];
    $scope.serviceListParams.key = val;
    $scope.serviceListParams.pageno = '1';
    $scope.serviceListFun($scope.serviceListParams);
  };
  //失去焦点事件
  $scope.inputBlur = function () {
    $scope.serviceListParams.key = $('.search-input').val();
  };


  //返回按钮
  $scope.goBack = function () {
    $state.go('guanjia-familyservice');
    $cookies.remove("businessId");
    $cookies.remove('city_fuwu_id');
  };

  //点击服务，进入服务详情页
  $scope.goServiceDetail = function (goodsId) {
    $state.go('guanjia-familyservicedetail', {
      goodsId: goodsId
    });
  };

  //点击预约，进入服务预约页
  $scope.goReserve = function ($event, goodsId) {
    $event.stopPropagation();
    sessionStorage.reserveGoodsId = goodsId;
    sessionStorage.stackIndex = 0
    $state.go('guanjia-servicereserve', {
      operate: 0,
      obj: {
        goodsId: goodsId
      }
    });
    //本地保存goodsId,以便服务预约中选择小区后跳转回预约页用
    localStorage.reserveGoodId = goodsId;
  }


  //跳转到卖家详情
  $scope.jumpSellerdetail = function () {
    $state.go('guanjia-sellerdetail', {businessId: $scope.businessId});
  };

}]);
//服务详情
guanjiaModuleController.controller('familyservicedetailCtrl', ['$scope', '$stateParams', 'guanjiaService', '$interval', '$q', '$state', '$cookies','$sce', function ($scope, $stateParams, guanjiaService, $interval, $q, $state, $cookies,$sce) {
  $scope.imgShow = true;

  function getServiceDetail() {
    var defer = $q.defer();
    guanjiaService.goodsDetail({
      goods_id: $stateParams.goodsId
    }).success(function (response) {
      if (response.code == '0') {

        $scope.serviceDetail = response.data;
        defer.resolve($scope.serviceDetail);

        //商品开卖倒计时
        $scope.sellTime = $scope.serviceDetail.start_date;
        if ($scope.sellTime.length > 0) {

          var time_start = new Date().getTime(); //设定当前时间
          var time_end = new Date($scope.sellTime).getTime(); //设定目标时间
          // 计算时间差
          var time = time_end / 1000 - time_start / 1000;
          if (time < 0) {
            $scope.showTimeHtml = '';
          }

         var showTime = $interval(function () {
            if (time <= 1) {
              $interval.cancel(showTime);
            } else {
              var time_start = new Date().getTime();
              var time_end = new Date($scope.sellTime).getTime();
              //// 计算时间差
              var time_distance = time_end - time_start;

              // 天
              var int_day = Math.floor(time_distance / 86400000);
              time_distance -= int_day * 86400000;
              // 时
              var int_hour = Math.floor(time_distance / 3600000);
              time_distance -= int_hour * 3600000;
              // 分
              var int_minute = Math.floor(time_distance / 60000);
              time_distance -= int_minute * 60000;
              // 秒
              var int_second = Math.floor(time_distance / 1000);
              // 时分秒为单数时、前面加零
              if (int_day < 10) {
                int_day = "0" + int_day;
              }
              if (int_hour < 10) {
                int_hour = "0" + int_hour;
              }
              if (int_minute < 10) {
                int_minute = "0" + int_minute;
              }
              if (int_second < 10) {
                int_second = "0" + int_second;
              }
              // 显示时间
              $scope.showTimeHtml = '开卖倒计时：' + int_day + '天' + int_hour + '时' + int_minute + '分' + int_second + '秒';
              time_distance--;
              time--;
            }
          }, 1000);
        } else {
          $('.count_down').css({
            'height': '2px'
          })
        }

        $scope.slides = $scope.serviceDetail.goods_images;
        if ($scope.slides != '') {
          //轮播图请求到数据1秒后显示
          setTimeout(function () {
            $scope.imgShow = false;
          }, 1000);
        }

        $scope.description = $sce.trustAsHtml($scope.serviceDetail.description);
      } else {
        console.log('服务详情接口有错误！');
      }
    });
    return defer.promise;
  }

  //服务详情
  $scope.detailPromise = getServiceDetail();
  //评价
  guanjiaService.listGoodsComment({
    goods_id: $stateParams.goodsId
  }).success(function (response) {
    if (response.code == '0') {
      $scope.serviceComment = response.data;
    } else {
      console.log('评价接口由错误！');
    }
  });

  //销量
  guanjiaService.getGoodsCount({
    goods_id: $stateParams.goodsId
  }).success(function (response) {
    if(response.data !=''){

      $scope.chartsContent=false;
      var _labels=[];
      for(var i= 0;i<response.data.labels.length;i++){
        var s=response.data.labels[i].slice(-2);
        if(i%2){//奇数
          _labels.push('');
        }else{//偶数
          _labels.push(s);
        }
      }
      $scope.labels = _labels;

      $scope.salesData = [
        response.data.data
      ];
      //$scope.onClick = function (points, evt) {
      //  console.log(points, evt);
      //};
      $scope.options = {
        showTooltips:false
      }
    }else{
      $scope.chartsContent=true;
    }
  });

  //点击预约，跳转到服务预约页
  $scope.goServiceReserve = function () {
    sessionStorage.reserveGoodsId = $stateParams.goodsId;
    sessionStorage.stackIndex = 1;
    $state.go('guanjia-servicereserve', {
      operate: 1,
      obj: {
        goodsId: $stateParams.goodsId
      }
    });
  }

  $scope.back = function () {
    //回到服务列表
    var bussinessId = sessionStorage.businessId;
    var bussinessName = sessionStorage.businessName;
    $state.go("guanjia-familyservicelist", {"businessId": bussinessId, "bussinessName": bussinessName})
  }

}]);

//服务预约
guanjiaModuleController.controller('servicereserveCtrl', ['$scope', 'guanjiaService', '$stateParams', 'commonService', '$state', '$timeout', 'userService', '$cookies', '$rootScope', 'reserveCacheService', function ($scope, guanjiaService, $stateParams, commonService, $state, $timeout, userService, $cookies, $rootScope, reserveCacheService) {

  //俩想你喜人输入框与联系电话输入框默认为当前的登陆用户的信息
  $scope.userName = ($rootScope.username == localStorage.mobile || $rootScope.username == undefined) ? "" : $rootScope.username;
  $scope.telephone = localStorage.mobile == undefined ? "" : localStorage.mobile
  $scope.count = 1;

  /*
   * superControl = 0 从服务列表跳转过来
   * superControl = 1 从服务详情跳转过来
   */
  var stackIndex = sessionStorage.stackIndex;

  /*
   * operate = 2 从选择我的小区跳转回来
   * operate = 3 从选择小区跳转回来
   */
  var operate = $stateParams.operate;
  var params = $stateParams.obj;

  guanjiaService.goodsDetail({
    goods_id: sessionStorage.reserveGoodsId
  }).success(function (response) {
    if (response.code == '0') {
      $scope.serviceReserve = response.data;
      $scope.totalPrice = $scope.serviceReserve.sale_price;
    }
  });

  //增减数量
  $scope.changeCount = function ($event) {
    if ($($event.target).val() == 'add') {
      $scope.count++;
    } else {
      if ($scope.count > 0) {
        $scope.count--;
      } else {
        commonService.showWarnMessage('亲，没啦，不用点啦！');
      }
    }
    $scope.totalPrice = parseFloat($scope.serviceReserve.sale_price) * parseInt($scope.count);
  };

  //处理从选择小区跳转回来的事情
  if (operate == 2 || operate == 3) {

    //var business = reserveCacheService.getProperty("business");
    //var goodsName = reserveCacheService.getProperty("name");
    //var goodsImageUrl = reserveCacheService.getProperty("imageUrl");
    //var priceRange = reserveCacheService.getProperty("priceRange");
    //var sale_price = reserveCacheService.getProperty("sale_price");
    //var old_price = reserveCacheService.getProperty("old_price");
    //var day_count = reserveCacheService.getProperty("day_count");
    //
    //var showPrice = priceRange == "" ? sale_price : (priceRange.min_sale_price + "~" + priceRange.max_sale_price);
    //var showOldPrice = priceRange == "" ? old_price : (priceRange.min_old_price + "~" + priceRange.max_old_price);
    //$scope.serviceReserve = {
    //  "business": business,
    //  "name": goodsName,
    //  "imageUrl": goodsImageUrl,
    //  "sale_price": showPrice,
    //  "old_price": showOldPrice,
    //  "day_count": day_count
    //}

    var selectedCount = reserveCacheService.getProperty("selectedCount");
    var remarks = reserveCacheService.getProperty("remarks");
    var userName = reserveCacheService.getProperty("userName");
    var telephone = reserveCacheService.getProperty("telephone");
    var floor = reserveCacheService.getProperty("floor");
    var community = reserveCacheService.getProperty("community");

    $scope.count = selectedCount;
    $scope.message = remarks;
    $scope.userName = userName;
    $scope.telephone = telephone;
    $scope.floor = floor;
    $scope.community = community;
  }

  //选择小区之后页面的数据填充
  //if (operate == 3){
  //
  //
  //  var selectedCount = reserveCacheService.getProperty("selectedCount");
  //  var remarks = reserveCacheService.getProperty("remarks");
  //  var userName = reserveCacheService.getProperty("userName");
  //  var telephone = reserveCacheService.getProperty("telephone");
  //  var floor = reserveCacheService.getProperty("floor");
  //  var community = reserveCacheService.getProperty("community");
  //
  //  $scope.count = selectedCount;
  //  $scope.message = remarks;
  //  $scope.userName = userName;
  //  $scope.telephone = telephone;
  //  $scope.floor = floor;
  //  $scope.community = community;
  //}

  //跳转到我的小区选择页
  $scope.goMyCommunity = function () {
    if ($cookies.get('ticket') == null) {
      $state.go('member-personal-login');
    } else {
      //在前往选择我的小区之前将当前的页面信息保存在reserveCacheService中
      reserveCacheService.setter($scope.serviceReserve);
      reserveCacheService.setProperty("selectedCount", $scope.count);  //保存用户当前输入的商品件数
      reserveCacheService.setProperty("remarks", $scope.message);     //保存用户输入的留言
      reserveCacheService.setProperty("userName", $scope.userName);     //保存联系人姓名
      reserveCacheService.setProperty("telephone", $scope.telephone);   //保存联系人电话
      reserveCacheService.setProperty("community", $scope.community);  //保存小区名称
      reserveCacheService.setProperty("floor", $scope.floor);           //保存楼房号

      localStorage.toMyCommunitySelect = 6;
      $state.go('service-mycommunityselect', {
        operate: 6,
        obj: {}
      });
    }

  };

  //前往小区列表选择小区
  $scope.selecteCommunity = function () {
    if ($cookies.get('ticket') == null) {
      $state.go('member-personal-login');
    } else {
      //在前往选择我的小区之前将当前的页面信息保存在reserveCacheService中
      reserveCacheService.setter($scope.serviceReserve);
      reserveCacheService.setProperty("selectedCount", $scope.count);  //保存用户当前输入的商品件数
      reserveCacheService.setProperty("remarks", $scope.message);     //保存用户输入的留言
      reserveCacheService.setProperty("userName", $scope.userName);     //保存联系人姓名
      reserveCacheService.setProperty("telephone", $scope.telephone);   //保存联系人电话
      reserveCacheService.setProperty("community", $scope.community);  //保存小区名称,小区id早选择了小区后再行保存
      reserveCacheService.setProperty("floor", $scope.floor);           //保存楼房号

      var reserveCache = reserveCacheService.getter();
      $state.go('member-user-selectcommunity', {
        operate: 3,
        obj: {}
      });
    }
  }

  //返回
  $scope.back = function () {
    if (stackIndex == 0) {
      //回到服务列表
      var bussinessId = sessionStorage.businessId;
      var bussinessName = sessionStorage.businessName;
      $state.go("guanjia-familyservicelist", {"businessId": bussinessId, "bussinessName": bussinessName})
    }
    if (stackIndex == 1) {
      //回到服务详情
      $state.go("guanjia-familyservicedetail", {"goodsId": sessionStorage.reserveGoodsId})
    }

  }

  var guige1, guige2;

  function getParams() {
    if (!(/^[1-9]*$/.test($scope.count))) {
      commonService.showNoticeMessage('数量只能是正整数！');
    } else if (!$scope.userName) {
      commonService.showNoticeMessage('请输入收货人姓名');
    } else if (!$scope.telephone) {
      commonService.showNoticeMessage('请输入收货人联系电话');
    } else if (!reserveCacheService.getProperty("communityId")) {
      commonService.showNoticeMessage('请选择收货人地址');
    } else {
      var guiges = $('.servicereserve-service-specification').find('.servicereserve-service-specification-row');
      if (guiges.length > 0) {
        $.each(guiges, function (index, elem) {
          var key = $(elem).children('.servicereserve-service-specification-name').html();
          var select = $(elem).find('.servicereserve-dropdown');
          var value = $(select).find('option:selected').text();
          if (index == 0) {
            guige1 = key + value;
          } else {
            guige2 = key + value;
          }
        });
      }
      return true;
    }
    return false;
  }

  //放入购物车
  $scope.insertCart = function () {
    var isContinue = getParams();
    if (isContinue) {
      var params = {
        ticket: $cookies.get('ticket'),
        mobile: localStorage.mobile,
        goods_id: $scope.serviceReserve.goods_id,
        count: $scope.count,
        guige_1: guige1,
        guige_2: guige2,
        remark: $scope.message,
        contact_name: $scope.userName,
        contact_phone: $scope.telephone,
        community_id: reserveCacheService.getProperty("communityId"),
        number: $scope.floor
      };
      guanjiaService.addcart(params).success(function (response) {
        console.log(response)
        if (response.code == '0') {
          commonService.showSuccessMessage('成功加入购物车！');
          $timeout(function () {
            $state.go('guanjia-familyservicelist', {
              businessId: sessionStorage.businessId,
              businessName: sessionStorage.businessName
            });
          }, 500);
        }
      });
    }
  };
  //直接预约
  $scope.straightReserve = function () {
    var isContinue = getParams();
    if (isContinue) {
      var goodsReserve = [];
      goodsReserve.push({
        goods_id: $scope.serviceReserve.goods_id,
        count: $scope.count,
        guige_1: guige1,
        guige_2: guige2,
        contact_name: $scope.userName,
        contact_phone: $scope.telephone,
        community_id: reserveCacheService.getProperty("communityId"),
        number: $scope.floor
      });
      var params = {"mobile": localStorage.mobile, "goods": goodsReserve};
      params = {json: JSON.stringify(params)};
      userService.postRequestWithUrlAndParams("buy.action", params).success(function (response) {
        if (response.code == '0') {
          commonService.showSuccessMessage('预约成功！');
          $timeout(function () {
            $state.go('guanjia-familyservicelist', {
              businessId: sessionStorage.businessId,
              businessName: sessionStorage.businessName
            });
          }, 500);
        } else if (response.code == '-4') {
          commonService.showWarnMessage('铛铛，商家休息了！');
        } else {
          console.log('直接预约接口有错误！');
        }
      });
    }
  }

}]);

//公共服务
guanjiaModuleController.controller('publicserviceCtrl', ['$scope', 'guanjiaService', '$sce', 'userService', '$q', 'commonService', '$state', '$cookies', '$rootScope', function ($scope, guanjiaService, $sce, userService, $q, commonService, $state, $cookies, $rootScope) {
  //选项卡切换
  var lastSelectItem = '.publicservice-default-selected-item';
  var lastShowTable = '.publicservice-government-table';

  function didSelectedSegementControl(currentItem, currentShowTable, isShowSearchField) {
    $(lastSelectItem).css({
      'border-bottom': 'none',
      'color': '#666'
    });
    $(currentItem).css({
      'border-bottom': '3px solid #7DB343',
      'color': '#7DB343'
    });
    $(currentItem).addClass('selected');
    $(lastSelectItem).removeClass('selected');

    $(lastShowTable).css({
      'display': 'none'
    });
    $(currentShowTable).css({
      'display': 'block'
    });

    lastSelectItem = currentItem;
    lastShowTable = currentShowTable;
  }

  $scope.showGovernment = function ($event) {
    $scope.isShowLis = true;
    $scope.getGovermentInfo();
    didSelectedSegementControl($event.target, ".publicservice-government-table", 0);
    $('.navigationbar-government').css({
      'display': 'block'
    });
    $('.navigationbar-publicservice').css({
      'display': 'none'
    });

  };
  $scope.showStreet = function ($event) {
    console.log('社区');
    $scope.isShowLis = true;
    $scope.shequLis = [];
    $scope.shequFun($scope.shequParams);
    didSelectedSegementControl($event.target, ".publicservice-street-table", 1);
    $('.navigationbar-government').css({
      'display': 'none'
    });
    $('.navigationbar-publicservice').css({
      'display': 'block'
    });

  };
  $scope.showManager = function ($event) {
    console.log('物业管理');
    $scope.isShowLis = true;
    $scope.wuyeLis = [];
    $scope.wuyeFun($scope.wuyeParams);
    didSelectedSegementControl($event.target, ".publicservice-manager-table", 1);
    $('.navigationbar-government').css({
      'display': 'none'
    });
    $('.navigationbar-publicservice').css({
      'display': 'block'
    });

  };

  //获取政府URL
  $scope.getGovermentInfo = function () {
    guanjiaService.listGovernmentInfo({
      city_id: sessionStorage.gpscityId
    }).success(function (response) {
      if (response.code == '0') {
        $scope.governmentUrl = $sce.trustAsResourceUrl(response.data.url);
        if (!$scope.governmentUrl) {
          $scope.tipInfo = '没有相关数据';
        }
      } else {
        console.log('this is error!');
      }
    });
  };
  $scope.getGovermentInfo();

  //社区街道
  $scope.shequParams = {
    "city_id": sessionStorage.gpscityId,
    'pageno': '1', //页码
    'pagesize': '10', //页数
    "url": 'listShequ.action',
    'direction': 'up',
    'key': ''
  };
  $scope.shequLis = [];
  var isOver = false; //false:标志数据未加载完成
  $scope.sheInfo = '';
  $scope.shequFun = function (params) {
    var defer = $q.defer();
    userService.postRequestWithPageNo(params).success(function (response) {
      switch (response.code) {
        case '0':
          if (response.data.length == 0 && params.pageno == '1') {
            $scope.sheInfo = '没有相关数据';
          } else {
            var tempList = response.data;
            if (tempList.length < params.pagesize) {
              isOver = true;//true:标志数据加载完成
              defer.resolve(isOver);
            } else {
              isOver = false;
              defer.resolve(isOver);
            }


            if (params.direction == 'down') {
              $scope.shequLis = response.data;
            } else {
              $scope.shequLis = $scope.shequLis.concat(tempList);
            }
          }
          break;
      }
    });
    return defer.promise;
  };


  //物业管理
  $scope.wuyeParams = {
    "city_id": sessionStorage.gpscityId,
    'pageno': '1', //页码
    'pagesize': '10', //页数
    "url": 'listWuye.action',
    'direction': 'up',
    'key': ''
  };
  $scope.wuyeLis = [];
  var isWY = false; //false:标志数据未加载完成
  $scope.wuyeInfo = '';
  $scope.wuyeFun = function (params) {
    var defer = $q.defer();
    userService.postRequestWithPageNo(params).success(function (response) {
      switch (response.code) {
        case '0':
          if (response.data.length == 0 && params.pageno == '1') {
            $scope.wuyeInfo = '没有相关数据';
          } else {
            var tempList = response.data;
            if (tempList.length < params.pagesize) {
              isOver = true;//true:标志数据加载完成
              defer.resolve(isOver);
            } else {
              isOver = false;
              defer.resolve(isOver);
            }

            if (params.direction == 'down') {
              $scope.wuyeLis = response.data;
            } else {
              $scope.wuyeLis = $scope.wuyeLis.concat(tempList);
            }
          }
          break;
      }
    });
    return defer.promise;
  };


  //关键字搜索
  var val = '';
  $scope.searchbyKey = function () {
    val = $('.search-input').val();
    var txt = '';
    //获取当前选项卡选中的按钮文本
    $.each($('.publicservice-sc-item'), function (index, domEl) {
      if ($(domEl).hasClass('selected')) {
        txt = $(domEl).next().html();
        return;
      }
    });
    if (txt == '社区街道') {
      $scope.sheInfo = '';
      $scope.shequParams.url = 'listShequ.action';
      $scope.shequParams.key = val;
      $scope.shequParams.pageno = '1';
      $scope.shequLis = [];
      $scope.shequFun($scope.shequParams);
    }
    if (txt == '物业管理') {
      $scope.wuyeInfo = '';
      $scope.wuyeParams.url = 'listWuye.action';
      $scope.wuyeParams.key = val;
      $scope.wuyeParams.pageno = '1';
      $scope.wuyeLis = [];
      $scope.wuyeFun($scope.wuyeParams);
    }
  };

  //返回
  $scope.toBack = function () {
    $state.go("guanjia-comservice");
  }

}]);

//家庭金融
guanjiaModuleController.controller('familyaccountCtrl', ['$scope', 'guanjiaService', '$state', 'commonService', '$cookies', 'userService', '$q', '$rootScope', function ($scope, guanjiaService, $state, commonService, $cookies, userService, $q, $rootScope) {

  //$scope.city_name = sessionStorage.gpscityName;
  //返回首页
  $scope.backtocomservice = function () {
    $state.go('guanjia-comservice');
  };
  //轮播图
  $scope.imgShow = true;
  var params = {
    "type": "system,city",
    "city_id": sessionStorage.gpscityId,
    "label": "金融"
  };
  guanjiaService.listad(params).success(function (response) {

    switch (response.code) {
      case '0':
        if (response.data) {
          $scope.adList = response.data;
          //$scope.adList = [{"imageUrl":"images/1.jpg"},{"imageUrl":"images/1.jpg"}];

          $scope.myInterval = 3000;
          var slides = $scope.slides;

          for (var i = 0; i < $scope.adList.length; i++) {
            var src = $scope.adList[i].imageUrl;
            slides.push({image: src, text: $scope.adList[i].name});
          }

          //轮播图请求到数据1秒后显示
          setTimeout(function () {
            $scope.imgShow = false;
          }, 1000);

        }

        break;
      case '-1':
        console.log("社区服务轮播图参数为空");
        break;
    }
  }).error(function (data, status, header, config) {

  });

  //获取公告数据
  guanjiaService.listNotice({
    type: "system,city",
    city_id: sessionStorage.gpscityId,
    "label": "金融"
  }).success(function (data) {
    $scope.marqueeContent = data.data;
    $.getScript('scripts/common/plugins/marquee.js', function () {
      createMarquee();
    });
  });


  //金融机构列表
  $scope.familyaccountList = [];
  $scope.params = {
    city_id: sessionStorage.gpscityId,
    pageno: '1', //页码
    pagesize: '10', //页数
    url: 'listBusinessByFuwuType.action',
    fuwu_type: '家庭金融',
    direction: 'up'
  };
  var isOver = false; //false:标志数据未加载完成
  $scope.errMsg = '';
  $scope.familyAccount = function (params) {
    var defer = $q.defer();
    userService.postRequestWithPageNo(params).success(function (response) {
      switch (response.code) {
        case '0':
          var tempList = response.data.list;
          $scope.allBusiness = response.data;
          $scope.city_fuwu_id = $scope.allBusiness.city_fuwuId;
          if (tempList.length == 0 && params.pageno == '1') {
            $scope.errMsg = '没有相关数据';
            return;
          }
          $scope.errMsg = '';
          if (tempList.length < params.pagesize) {
            isOver = true;//true:标志数据加载完成
            defer.resolve(isOver);
          } else {
            isOver = false;
            defer.resolve(isOver);
          }

          if (params.direction == 'down') {//下拉刷新
            $scope.familyaccountList = response.data.list;
          } else {//上拉加载
            $scope.familyaccountList = $scope.familyaccountList.concat(tempList);
          }

          break;
        case '-1':
          //参数为空
          $scope.errMsg = '请求有误';
          break;
        case '-2':
          //金融服务不存在
          $scope.errMsg = '没有相关数据';
          break;
      }
    });
    return defer.promise;
  };

  $scope.familyAccount($scope.params);

  /***********************关键字搜索*****************************************/
  var val = '';
  $scope.searchAccount = function () {
    $scope.familyaccountList = [];
    val = $('.search-input').val();
    $scope.params.key = val;
    $scope.params.pageno = 1;
    $scope.familyAccount($scope.params);
  };

  //金融列表
  $scope.jumpaccountlist = function (businessId) {
    $state.go('guanjia-familyaccountlist');
    var expireDate = new Date();
    expireDate.setDate(expireDate.getDate() + 30);
    //存放商家ID
    if (null == businessId) {
      $cookies.put('city_fuwu_id', $scope.city_fuwu_id, {'expires': expireDate.toUTCString()});
    } else {
      $cookies.remove('city_fuwu_id');
    }
    $cookies.put('from', '%jinrong%', {'expires': expireDate.toUTCString()});
    $cookies.put('businessId', businessId, {'expires': expireDate.toUTCString()});
  };


}]);
//金融商品列表
guanjiaModuleController.controller('familyaccountlistCtrl', ['$scope', 'guanjiaService', '$stateParams', 'userService', 'commonService', '$state', '$cookies', '$q', function ($scope, guanjiaService, $stateParams, userService, commonService, $state, $cookies, $q) {

  $scope.accountbusinessId = $cookies.get('businessId');
  $scope.city_fuwu_id = $cookies.get('city_fuwu_id');

  if ($scope.accountbusinessId == null && $scope.city_fuwu_id == null) {
    $state.go('guanjia-comservice');
  }

  //返回金融机构列表
  $scope.backtofamilyaccount = function () {
    $state.go('guanjia-familyaccount');
  };

  //商家详情
  if(null!=$scope.accountbusinessId){
    guanjiaService.businessDetail(
      {
        business_id: $scope.accountbusinessId,
      }).success(function (data) {
      $scope.business = data.data;
    });
  }
  //调用分类接口
  $scope.getCategory = function () {
    var defer = $q.defer();
    guanjiaService.listCategory({
      business_id: $scope.accountbusinessId,
      city_fuwu_id: $scope.city_fuwu_id
    }).success(function (data) {
      if (data.code == '0') {
        $scope.category = data.data;
        $scope.category.unshift({category_id: '1', name: '全部'});
        defer.resolve($scope.category);
        //获取分类的index，保存在数组$scope.category_count中
        $scope.category_count = [];
        $.each($scope.category, function (index, info) {
          $scope.category_count.push(index);
        });
        //index为$scope.category_count.length的为全部
        $scope.category_count.push($scope.category_count.length);
        //默认获取全部数据
        $scope.accountListFun($scope.params);
      } else {
        console.log('获取分类信息有误！');
      }
    });
    return defer.promise;
  };

  $scope.accountlistPromise = $scope.getCategory();

  $scope.params = {
    business_id: $scope.accountbusinessId,
    city_fuwu_id: $scope.city_fuwu_id,
    pageno: '1', //页码
    pagesize: '10', //页数
    url: 'listGoods.action',
    category_id: null,
    sort: 'up_date',
    direction: 'up',
    key: ''
  };

  $scope.accountList = [];
  var isOver = false;//false:标志数据未加载完成
  $scope.errMsg = '';
  $scope.accountListFun = function (params) {
    var defer = $q.defer();
    userService.postRequestWithPageNo(params).success(function (response) {
      if (response.code == '0') {
        var tempList = response.data;
        if (tempList.length == 0 & params.pageno == '1') {
          $scope.errMsg = '没有相关数据';
          return;
        }
        $scope.errMsg = '';
        if (tempList.length < params.pagesize) {
          isOver = true;//true:标志数据加载完成
          defer.resolve(isOver);
        } else {
          isOver = false;
          defer.resolve(isOver);
        }
        if (params.direction == 'down') {
          $scope.accountList = response.data;
        } else {
          $scope.accountList = $scope.accountList.concat(tempList);
        }
      } else {
        console.log('familyaccoutlistCtrl 获取信息失败！');
      }
    });
    return defer.promise;
  };

  //获取公告数据
  guanjiaService.listNotice({
    type: 'business',
    business_id: $scope.accountbusinessId
  }).success(function (data) {
    $scope.marqueeContent = data.data;

    $.getScript('scripts/common/plugins/marquee.js', function () {
      createMarquee();
    });
  });

  //分类按钮的点击效果
  $scope.changecate = function (id, index, type) {
    if (id == '1') {
      $scope.index = $scope.category_count.length - 1;
      $scope.params.category_id = null;
    } else {
      $scope.index = index;
      $scope.params.category_id = id;
    }
    $scope.accountList = [];
    $scope.params.pageno = 1;
    $scope.accountListFun($scope.params);
  };

  /**********************关键字搜索************************************/
  var val = '';
  $scope.searchAccount = function () {
    $scope.accountList = [];
    val = $('.search-input').val();
    $scope.params.pageno = 1;
    $scope.params.key = val;
    $scope.accountListFun($scope.params);
  };
  //失去焦点时，获取key的值
  $scope.accountlistBlur = function () {
    $scope.params.key = $('.search-input').val();
  };

  //进入商品详情
  $scope.jumpaccountDetail = function (id, name) {
    $state.go('guanjia-familyaccountdetail', {
      goodsId: id
      //businessId: $scope.accountbusinessId,
      //businessName: $scope.accountbusinessName
    });
  };

  //跳转到卖家详情
  $scope.jumpSellerdetail = function () {
    $state.go('guanjia-sellerdetail', {businessId: $scope.accountbusinessId});
  };
}]);

//金融商品详情
guanjiaModuleController.controller('familyaccountdetailCtrl', ['$scope', 'guanjiaService', '$interval', '$stateParams', '$state', 'commonService', '$cookies', function ($scope, guanjiaService, $interval, $stateParams, $state, commonService, $cookies) {
  //$scope.accountgoodsId = $stateParams.goodsId;
  //$scope.accountgoodsName = $stateParams.goodsName;
  //$scope.accountbusinessId=$stateParams.businessId;
  //$scope.accountbusinessName=$stateParams.businessName;

  //返回商品列表
  //$scope.backtofamilyaccountlist=function(){
  //  $state.go('guanjia-familyaccountlist',{
  //    businessName:$scope.accountbusinessName,
  //    businessId: $scope.accountbusinessId
  //  })
  //};
  $scope.goodsId = $stateParams.goodsId;
  $scope.imgShow = true;

  //调用商品详情接口
  guanjiaService.goodsDetail({'goods_id': $scope.goodsId}).success(function (data) {
    switch (data.code) {
      case '0':
        if (data.data != '') {
          $scope.accountgoodsList = data.data;

          //商品开卖倒计时
          $scope.sellTime = $scope.accountgoodsList.start_date;
          if ($scope.sellTime.length > 0) {

            var time_start = new Date().getTime(); //设定当前时间
            var time_end = new Date($scope.sellTime).getTime(); //设定目标时间
            // 计算时间差
            var time = time_end / 1000 - time_start / 1000;
            if (time < 0) {
              $scope.showTimeHtml = '';
            }

            var showTime = $interval(function () {
              if (time <= 1) {
                $interval.cancel(showTime);
              } else {
                var time_start = new Date().getTime();
                var time_end = new Date($scope.sellTime).getTime();
                //// 计算时间差
                var time_distance = time_end - time_start;

                // 天
                var int_day = Math.floor(time_distance / 86400000);
                time_distance -= int_day * 86400000;
                // 时
                var int_hour = Math.floor(time_distance / 3600000);
                time_distance -= int_hour * 3600000;
                // 分
                var int_minute = Math.floor(time_distance / 60000);
                time_distance -= int_minute * 60000;
                // 秒
                var int_second = Math.floor(time_distance / 1000);
                // 时分秒为单数时、前面加零
                if (int_day < 10) {
                  int_day = "0" + int_day;
                }
                if (int_hour < 10) {
                  int_hour = "0" + int_hour;
                }
                if (int_minute < 10) {
                  int_minute = "0" + int_minute;
                }
                if (int_second < 10) {
                  int_second = "0" + int_second;
                }
                // 显示时间
                $scope.showTimeHtml = '开卖倒计时：' + int_day + '天' + int_hour + '时' + int_minute + '分' + int_second + '秒';
                time_distance--;
                time--;
              }
            }, 1000);
          } else {
            $('.count_down').css({
              'height': '2px'
            })
          }

          $scope.slides = $scope.accountgoodsList.goods_images;
          if ($scope.slides != '') {
            //轮播图请求到数据1秒后显示
            setTimeout(function () {
              $scope.imgShow = false;
            }, 1000);
          }
        } else {
          commonService.showWarnMessage("暂无商品信息！");
        }
        break;
      case '-1':
        commonService.showWarnMessage('参数为空');
        break;
      case '-2':
        commonService.showErrorMessage('参数错误');
        break;
    }
  });
}]);
